.. _usage_expression:

Parcellating expression data
============================

.. _usage_expression_basic:

Basic usage
-----------

Once you've downladed the microarray data and selected your parcellation you
can process the data. This should be as simple as:

.. doctest::
    :options: +SKIP

    >>> expression = abagen.get_expression_data(atlas['image'])

If you are using a volumetric image it is highly recommended you provide the
additional information on your parcellation, which can be done with:

.. doctest::

    >>> expression = abagen.get_expression_data(atlas['image'], atlas['info'])

.. note::

    By default this function will use data from *all* the donors! Wrangling all
    this raw microarray data can be quite time-consuming, so if you'd like to
    speed up this step make sure you've performed the :ref:`io_installation`.
    Alternatively, if you don’t want to use all the donors when testing or
    debugging the code, you can provide the subject IDs of the donors you want
    (e.g., ``donors=['9861', '10021']``).

The :func:`abagen.get_expression_data` function will print out some information
about what's happening as it goes. However, briefly the function:

    1. Fetches the microarray data from AHBA (if this has not already been
       done). Refer to parameters ``data_dir`` and ``donors`` for more info.
    2. Updates the MNI coordinates of all the tissue samples from AHBA using
       the coordinates from the ``alleninf`` package. This occurs by default;
       refer to parameter ``corrected_mni`` for more info.
    3. Mirrors samples across hemispheres to increase spatial coverage. This
       does not occur by default; refer to parameter ``lr_mirror`` for more
       info (or see :ref:`usage_expression_lrmirror`).
    4. Reannotates microarray probe-to-gene mappings with information from
       Arnatkevic̆iūtė et al., 2019, NeuroImage. This occurs by default; refer
       to parameter ``reannotated`` for more info.
    5. Performs intensity-based filtering of probes to remove those that do not
       exceed background noise. This occurs by default with a threshold of
       0.5 (i.e., probes must exceed background noise in 50% of all tissue
       samples); refer to parameter ``ibf_threshold`` for more info.
    6. Selects a representative probe amongst those probes indexing the same
       gene. This occurs by default by selecting the probe with the highest
       differential stability amongst donors; refer to parameter
       ``probe_selection`` for more info (or see :ref:`usage_probes`).
    7. Matches tissue samples to regions in the user-specified ``atlas``. Refer
       to parameters ``atlas``, ``atlas_info``, ``exact``, and ``tolerance``
       for more info (or see :ref:`usage_expression_exact`).
    8. Normalizes expression values for each sample across genes for each
       donor. This occurs by default using a scaled robust sigmoid
       normalization function; refere to parameter ``sample_norm`` for more
       info.
    9. Normalizes expression values for each gene across samples for each
       donor. This occurs by default using a scaled robust sigmoid
       normalization function; refer to parameter ``gene_norm`` for more info.
    10. Aggregates samples within regions in the user-specified ``atlas`` based
        on matches made in Step 7. By default, samples are averaged separately
        for each donor and then averaged across donors. Refer to parameters
        ``region_agg``, ``agg_metric``, and ``return_donors`` for more info.

You can investigate all these parameters and options for modifying how the
``expression`` array is generated by looking at the :ref:`api_ref`.

.. _usage_expression_dataframe:

The parcellated expression DataFrame
------------------------------------

The ``expression`` object returned by :func:`abagen.get_expression_data` is a
``pandas.DataFrame``, where rows correspond to region labels as defined in the
atlas image, columns correspond to genes, and entry values are microarray
expression data normalized and aggregated across donors:

.. doctest::

    >>> print(expression)
    gene_symbol      A1BG  A1BG-AS1       A2M  ...       ZYX     ZZEF1      ZZZ3
    label                                      ...
    1            0.498266  0.664570  0.395276  ...  0.675843  0.555539  0.487572
    2            0.649068  0.578997  0.496142  ...  0.483165  0.382653  0.504041
    3            0.530613  0.623289  0.516300  ...  0.732930  0.359707  0.450664
    ...               ...       ...       ...  ...       ...       ...       ...
    81           0.388748  0.277961  0.474202  ...  0.279683  0.480953  0.405504
    82           0.825836  0.602271  0.334143  ...  0.195722  0.447894  0.746475
    83           0.384593  0.203654  0.746060  ...  0.379274  0.706803  0.509437
    <BLANKLINE>
    [83 rows x 15633 columns]

By default the data are normalized using a scaled robust sigmoid function such
that expression values for a given gene will range from 0-1, where 0 indicates
the region with the lowest expression of that gene and 1 indicates the region
with highest.

Since the generated DataFrame is an aggregate (default: average) of multiple
donors it is possible (likely) that a given region may not have any expression
values *exactly* equal to 0 or 1.

.. _usage_expression_dense:

Getting dense expression data
-----------------------------

Unfortunately, due to how tissue samples were collected from the donor brains
it is possible that some regions in an atlas may not be represented by any
expression data. In the above example, one of the rows (not displayed) is
missing data. That region, corresponding to the right temporal pole in the
Desikan-Killiany atlas, was not matched to any tissue samples; this is likely
due to the fact that only two of the six donors have tissue samples taken from
the right hemisphere.

If you require a *dense* matrix---that is, you need expression values for
**every** region in your ``atlas``---there are a few parameters that you can
consider tuning to try and achieve this.

.. _usage_expression_exact:

Inexact matching with the ``exact`` parameter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

By default, the :func:`abagen.get_expression_data` function will attempt to be
as precise as possible in matching microarray samples with brain regions. It
takes the following steps to do this for each tissue sample:

    1. Determine if the sample falls directly within a region of ``atlas``.
    2. Check to see if the sample is close to any regions by slowly expanding
       the search space (in 1mm increments) to include nearby voxels up to a
       specified distance threshold (specified via the ``tolerance``
       parameter).
    3. If there are multiple nearby regions, determine which region is closer
       by calculating the center-of-mass of the abutting regions.

If at any step a sample can be assigned to a region in ``atlas`` the sample is
assigned to that region and the matching procedure is terminated. However, as
we saw, regions with no assigned samples from any donor are simply left as NaN.

If you would like to force all regions to be assigned at least one sample you
can set ``exact=False``. By doing this, the function will go through the
normal procedure documented above and then, once all samples are matched,
check for any remaining "empty" regions and assign them the expression values
of the sample falling closest to the center of mass of that region. In this
way every brain region is matched to *at least* one sample.

Thus, passing ``exact=False`` when calling :func:`abagen.get_expression_data`
will return a dense matrix (at the expense of some anatomical precision):

.. insert figure demonstration matching of samples with ``exact`` parameter

.. doctest::
    :options: +SKIP

    >>> exp_exact = abagen.get_expression_data(atlas['image'], atlas['info'], exact=False)
    >>> print(exp_exact)
    gene_symbol      A1BG  A1BG-AS1       A2M  ...       ZYX     ZZEF1      ZZZ3
    label                                      ...
    1            0.498266  0.664570  0.395276  ...  0.675843  0.555539  0.487572
    2            0.649068  0.578997  0.496142  ...  0.483165  0.382653  0.504041
    3            0.530613  0.623289  0.516300  ...  0.732930  0.359707  0.450664
    ...               ...       ...       ...  ...       ...       ...       ...
    81           0.388748  0.277961  0.474202  ...  0.279683  0.480953  0.405504
    82           0.825836  0.602271  0.334143  ...  0.195722  0.447894  0.746475
    83           0.384593  0.203654  0.746060  ...  0.379274  0.706803  0.509437
    <BLANKLINE>
    [83 rows x 15633 columns]

.. note::

    Refer to the documentation for :ref:`normalization <usage_norm_matched>`
    for additional information on how other settings interact with the
    ``exact`` parameter.

.. _usage_expression_lrmirror:

Duplicating samples with the ``lr_mirror`` parameter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

If your parcellation is sufficiently low-resolution it is likely that most
regions in the left hemisphere (for which all six donors have tissue samples)
will be matched to at least one sample, whereas regions in the right hemisphere
may come up short.

To remedy this you can try modifying the ``lr_mirror`` parameter when calling
:func:`abagen.get_expression_data`. This parameter accepts four options:
``None`` (default), ``"bidirectional"``, ``"leftright"``, and ``"rightleft"``.
As the name suggests, the ``lr_mirror`` options control whether tissue samples
are mirrored across the left/right hemisphere axis. By supplying the
'bidirectional' options, all samples in the left hemisphere are duplicated and
mirrored onto the right hemisphre, and vice-versa for right to left. The other
options ('leftright' and 'rightleft) will mirror only one hemisphere (i.e.,
'leftright' will mirror samples in the left onto the right hemisphere.

Unlike the ``exact=False`` parameter this will *not guarantee* that all regions
are matched to a sample, but it will dramatically increase the likelihood that
this will happen:

.. insert figure demonstrating duplication of samples across hemispheres

.. doctest::
    :options: +SKIP

    >>> exp_mirror = abagen.get_expression_data(atlas['image'], atlas['info'], lr_mirror='bidirectional')
    >>> print(exp_mirror)
    gene_symbol      A1BG  A1BG-AS1       A2M  ...       ZYX     ZZEF1      ZZZ3
    label                                      ...
    1            0.514338  0.691953  0.390986  ...  0.691840  0.538245  0.486501
    2            0.653746  0.609322  0.493803  ...  0.510645  0.378333  0.501096
    3            0.544552  0.652888  0.498815  ...  0.746333  0.352606  0.451558
    ...               ...       ...       ...  ...       ...       ...       ...
    81           0.399551  0.323719  0.451180  ...  0.295613  0.466063  0.408706
    82           0.828917  0.647376  0.319176  ...  0.211900  0.437627  0.729864
    83           0.388761  0.227823  0.696862  ...  0.411122  0.660371  0.474854
    <BLANKLINE>
    [83 rows x 15633 columns]

Note that since this effectively duplicates the number of tissue samples the
function runtime will increase somewhat. Also notice how the ``lr_mirror``
parameter changes the expression values for all the regions more dramatically
than the ``exact=True`` parameter. It is worth considering which (if either!)
of these options best suits your intended analysis.
